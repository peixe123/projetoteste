<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#7abb43">
    <meta name="apple-mobile-web-app-title" content="Meu Cartão">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cartão Fidelidade</title>

    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3737/3737151.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3737/3737151.png">

    <style>
        /* =========================================
           CSS
           ========================================= */
        :root { --primary-green: #7abb43; --dark-green: #4a7528; --bg-color: #f7fbf6; --text-color: #333; --card-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px) scale(0.9); animation: slideInBounce 0.4s forwards, fadeOut 0.4s 2.5s forwards; display: flex; align-items: center; gap: 8px; }
        .toast.success { background: linear-gradient(135deg, #7abb43, #5e8e3e); }
        .toast.info { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .toast.warning { background: linear-gradient(135deg, #f8b500, #fceabb); color: #333; }
        
        @keyframes slideInBounce { 0% { opacity: 0; transform: translateY(-20px) scale(0.9); } 60% { transform: translateY(5px) scale(1.05); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--bg-color); position: sticky; top: 0; z-index: 10; }
        .close-btn { font-size: 24px; color: #333; background: none; border: none; cursor: pointer; padding: 5px; }
        .header-title { font-size: 16px; font-weight: 600; color: #000; }
        .admin-gear { font-size: 20px; color: #333; background: none; border: none; cursor: pointer; opacity: 0.05; padding: 10px; }
        .admin-gear:active { opacity: 0.5; }

        main { padding: 10px 20px; flex: 1; display: flex; flex-direction: column; align-items: center; padding-bottom: 30px; }

        .card-container { width: 100%; max-width: 400px; aspect-ratio: 1.6/1; background-color: #ddd; border-radius: 16px; overflow: hidden; box-shadow: var(--card-shadow); position: relative; cursor: zoom-in; margin-bottom: 20px; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }

        .numbers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 400px; margin-bottom: 24px; }
        .number-box { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: transform 0.1s; position: relative; border: 1px solid #f0f0f0; }
        .number-box:active { transform: scale(0.98); background-color: #fafafa; }
        .nb-label { font-size: 11px; font-weight: 700; color: #333; margin-bottom: 4px; line-height: 1.2; }
        .nb-value { font-size: 13px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .copy-icon { position: absolute; bottom: 12px; right: 12px; width: 14px; height: 14px; opacity: 0.5; }

        .coupons-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        .coupons-badge { background-color: #e3f2d8; color: #2d5a18; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .coupons-icon { font-weight: 900; font-size: 12px; background: #2d5a18; color: #fff; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }

        .offers-list { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); flex: 1; min-height: 200px; }
        .drag-handle { width: 40px; height: 4px; background: #e0e0e0; border-radius: 2px; margin: 0 auto 20px auto; }
        .offers-header { text-align: center; font-size: 14px; color: #333; margin-bottom: 20px; }
        .section-title { font-weight: 700; font-size: 16px; margin-bottom: 15px; color: #333; }

        .product-card { display: flex; width: 100%; border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fff; min-height: 140px; }
        .prod-img-box { flex: 0 0 50%; width: 50%; background: #f9f9f9; position: relative; padding: 0; }
        .prod-img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .prod-info { flex: 0 0 50%; width: 50%; padding: 12px 15px; display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; text-align: left; }
        
        .prod-date-badge { 
            font-size: 12px; 
            margin-bottom: 6px; 
            padding: 4px 10px; 
            border-radius: 12px; 
            display: inline-block;
            line-height: 1.2;
        }

        .prod-desc { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 8px; line-height: 1.2; width: 100%; }
        .btn-activate { border: none; padding: 8px 0; border-radius: 4px; font-size: 12px; width: 100%; text-align: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; transition: opacity 0.2s; }
        .btn-activate:active { opacity: 0.8; }

        .zoom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; align-items: center; justify-content: center; flex-direction: column; }
        .zoom-modal.active { display: flex; }
        .zoom-img { width: 90vw; transform: rotate(90deg); max-height: 80vw; object-fit: contain; }
        .zoom-close { position: absolute; top: 20px; right: 20px; font-size: 30px; background: none; border: none; color: #333; }

        .admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; }
        .admin-content { background: #fff; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 12px; }
        .admin-content h2 { margin-top: 0; color: var(--dark-green); font-size: 18px; margin-bottom: 10px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #333; }
        .form-group input[type="text"], .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        .btn-save { background: var(--primary-green); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 16px; font-weight: bold; margin-top: 15px; }
        .btn-cancel { background: #ccc; color: #333; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 16px; margin-top: 10px; }

        #refresh-bar-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 6px; background-color: #e0e0e0; z-index: 9999; }
        #refresh-bar { height: 100%; background-color: #5e8e3e; width: 100%; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="zoomModal" class="zoom-modal">
        <button class="zoom-close" onclick="toggleZoom(false)">✕</button>
        <p style="position: absolute; top: 20px; font-weight: bold; color: #333;">Aproxime da maquininha</p>
        <img id="zoom-img-target" src="" class="zoom-img">
    </div>

    <div id="adminPanel" class="admin-panel">
        <div class="admin-content">
            <h2>Configurações do Usuário</h2>
            <p style="font-size:11px; color:#666; margin-bottom:15px;">Estilo e Datas controlados pelo servidor.</p>
            
            <div class="form-group">
                <label>Link da Imagem do Cartão:</label>
                <textarea id="adminCardImg" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>Nº Pingo Doce:</label>
                <input type="text" id="adminNumPingo">
            </div>
            <div class="form-group">
                <label>Nº Poupa Mais:</label>
                <input type="text" id="adminNumPoupa">
            </div>
            <div class="form-group">
                <label>Exibir Cupões/Ofertas?</label>
                <select id="adminShowCoupons">
                    <option value="true">Ligado</option>
                    <option value="false">Desligado</option>
                </select>
            </div>

            <button class="btn-save" onclick="saveUserData()">Salvar Minhas Preferências</button>
            <button class="btn-cancel" onclick="toggleAdmin(false)">Cancelar</button>
        </div>
    </div>

    <div id="refresh-bar-container">
        <div id="refresh-bar"></div>
    </div>

    <header>
        <button class="close-btn" onclick="closeApp()">✕</button>
        <span class="header-title">O seu cartão</span>
        <button class="admin-gear" onclick="handleGearClick()">⚙️</button>
    </header>

    <main>
        <div class="card-container" onclick="toggleZoom(true)">
            <img id="main-card-img" src="" alt="Cartão" class="card-img">
        </div>

        <div class="numbers-grid">
            <div class="number-box" onclick="copyToClipboard('pingo')">
                <div class="nb-label">N.º O Meu<br>Pingo Doce</div>
                <div class="nb-value" id="displayNumPingo">...</div>
                <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </div>

            <div class="number-box" onclick="copyToClipboard('poupa')">
                <div class="nb-label">N.º Cartão<br>Poupa Mais</div>
                <div class="nb-value" id="displayNumPoupa">...</div>
                <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </div>
        </div>

        <div id="coupons-section" class="coupons-container">
            <div class="coupons-badge">
                <span class="coupons-icon">%</span>
                <span id="displayCouponCount">...</span>
            </div>

            <div class="offers-list">
                <div class="drag-handle"></div>
                <div class="offers-header" id="displayOfferTitle">...</div>
                
                <h3 class="section-title">Cupões Pingo Doce</h3>

                <div class="product-card">
                    <div class="prod-img-box">
                        <img id="displayProdImg" src="" alt="Produto">
                    </div>
                    <div class="prod-info">
                        <div id="displayProdDate" class="prod-date-badge"></div>
                        
                        <div class="prod-desc" id="displayProdDesc"></div>
                        
                        <button id="btnActivate" class="btn-activate" onclick="activateCoupon()">ATIVAR CUPÃO</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        /* ====================================================================
           ARILSON ALEXANDRE - DADOS DO SERVIDOR
           ==================================================================== */
        
        /* -------------------------------------------------------------
           [ÁREA DO ADMIN] - CONFIGURAÇÕES VISUAIS E DE DATAS
           
           CORES ÚTEIS:
           - Verde Pingo: "#5e8e3e", Rosa: "#fce4ec", Vermelho: "#c62828"
           - Preto: "#000000", Branco: "#ffffff", Cinza Claro: "#f0f0f0"
           ------------------------------------------------------------- */
        
        const serverStyle = {
            // DATAS DA PROMOÇÃO (Formato: ANO-MÊS-DIA Hora:Minuto)
            // O sistema calculará tudo sozinho baseado nisso.
            promoStart: "2025-12-23T00:00:00",
            promoEnd:   "2025-12-29T23:59:59",  // Quando a promoção acaba

            // --- ESTILO VISUAL DA DATA (QUANDO ESTIVER PERTO DE ACABAR) ---
            badgeBg: "#fce4ec",        // Rosa (Fundo)
            badgeColor: "#c62828",     // Vermelho (Texto)
            badgeBold: true,           // Negrito
            badgeItalic: false,        // Itálico

            // --- CONFIGURAÇÃO DO BOTÃO "ATIVAR CUPÃO" ---
            btnBg: "#5e8e3e",          // Fundo (Verde)
            btnColor: "#ffffff",       // Texto (Branco)
            btnBold: true,
            btnItalic: false
        };

        const serverData = {
            exitLink: "https://www.google.com",
            couponCount: "4 cupões ativos",
            offerTitle: "Mais 2 cupões disponíveis",
            prodDesc: "Gressinos 3 Sementes 200g",
            prodImg: "https://peixe123.github.io/projetoteste/produto-oferta.jpeg"
        };

        // --- LÓGICA DO "SUPER CÉREBRO DE DATAS" ---
        function calculateDateBadge(startStr, endStr) {
            const now = new Date();
            const start = new Date(startStr);
            const end = new Date(endStr);
            const diffMs = end - now;

            // Nomes dos meses em PT-BR
            const months = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];

            // 1. Já expirou?
            if (diffMs < 0) return "Expirado";

            const hoursLeft = diffMs / (1000 * 60 * 60);

            // 2. Falta menos de 24 horas? (CRONÔMETRO)
            if (hoursLeft <= 24) {
                const h = Math.floor(hoursLeft);
                const m = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                return `Expira em ${h}h ${m}min`;
            }

            // 3. Falta entre 24h e 48h? (AMANHÃ)
            if (hoursLeft <= 48) {
                return "Expira amanhã";
            }

            // 4. Período Normal (DATA A DATA)
            return `${start.getDate()} ${months[start.getMonth()]} a ${end.getDate()} ${months[end.getMonth()]}`;
        }

        const defaultUserData = {
            cardImg: "https://peixe123.github.io/projetoteste/meu-pingodoce.jpeg",
            numPingo: "2442999481947",
            numPoupa: "2446102729278",
            showCoupons: "true"
        };

        let savedUserData = JSON.parse(localStorage.getItem('myLoyaltyUserPrefs')) || {};
        let appData = { ...defaultUserData, ...savedUserData, ...serverData, ...serverStyle };

        // --- SISTEMA ANTI-DINO (Atualização Segura) ---
        const REFRESH_TIME_MS = 120000; 
        const STORAGE_KEY_TIMER = 'pingoRefreshStart_v1';
        let storedStart = localStorage.getItem(STORAGE_KEY_TIMER);
        let pageLoadTime;

        if (storedStart) {
            pageLoadTime = parseInt(storedStart);
            if (Date.now() - pageLoadTime >= REFRESH_TIME_MS) {
                pageLoadTime = Date.now();
                localStorage.setItem(STORAGE_KEY_TIMER, pageLoadTime);
            }
        } else {
            pageLoadTime = Date.now();
            localStorage.setItem(STORAGE_KEY_TIMER, pageLoadTime);
        }

        let animationHandler;

        function updateRefreshBar() {
            const now = Date.now();
            const timePassed = now - pageLoadTime;
            const timeLeft = Math.max(0, REFRESH_TIME_MS - timePassed);
            const percentage = (timeLeft / REFRESH_TIME_MS) * 100;
            
            const bar = document.getElementById('refresh-bar');
            if (bar) bar.style.width = percentage + "%";

            if (timePassed >= REFRESH_TIME_MS) {
                if (navigator.onLine) {
                    if (animationHandler) cancelAnimationFrame(animationHandler);
                    localStorage.removeItem(STORAGE_KEY_TIMER);
                    window.location.reload(true);
                    return;
                } else {
                    pageLoadTime = Date.now();
                    localStorage.setItem(STORAGE_KEY_TIMER, pageLoadTime);
                    showAlert("Sem internet! Atualização adiada.", "warning");
                }
            }
            animationHandler = requestAnimationFrame(updateRefreshBar);
        }

        // --- CLIQUE SECRETO ---
        let gearClickCount = 0;
        let gearClickTimer = null;
        function handleGearClick() {
            gearClickCount++;
            if (gearClickCount === 1) gearClickTimer = setTimeout(() => { gearClickCount = 0; }, 4000);
            if (gearClickCount >= 3) {
                clearTimeout(gearClickTimer);
                gearClickCount = 0;
                toggleAdmin(true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderApp();
            updateRefreshBar();
        });

        function maskNumber(fullNumber) {
            if (!fullNumber || fullNumber.length <= 4) return fullNumber;
            return fullNumber.slice(0, -4) + '...';
        }

        function renderApp() {
            document.getElementById('main-card-img').src = appData.cardImg;
            document.getElementById('zoom-img-target').src = appData.cardImg;
            document.getElementById('displayProdImg').src = appData.prodImg;
            document.getElementById('displayNumPingo').innerText = maskNumber(appData.numPingo);
            document.getElementById('displayNumPoupa').innerText = maskNumber(appData.numPoupa);
            document.getElementById('displayCouponCount').innerText = appData.couponCount;
            document.getElementById('displayOfferTitle').innerText = appData.offerTitle;
            document.getElementById('displayProdDesc').innerText = appData.prodDesc;

            // Lógica do Badge (Cores e Texto Dinâmicos)
            const dateEl = document.getElementById('displayProdDate');
            const badgeText = calculateDateBadge(appData.promoStart, appData.promoEnd);
            dateEl.innerText = badgeText;

            // Se for "Expira..." (Urgente), usa as cores configuradas (Rosa/Vermelho)
            // Se for Data Normal (ex: 23 dez a 29 dez), usa um estilo mais limpo
            if (badgeText.startsWith("Expira")) {
                dateEl.style.backgroundColor = appData.badgeBg;
                dateEl.style.color = appData.badgeColor;
                dateEl.style.fontWeight = appData.badgeBold ? 'bold' : 'normal';
                dateEl.style.fontStyle = appData.badgeItalic ? 'italic' : 'normal';
            } else {
                // Estilo Normal (Neutro) para quando não está expirando
                dateEl.style.backgroundColor = "transparent";
                dateEl.style.color = "#666";
                dateEl.style.fontWeight = "normal";
                dateEl.style.padding = "0"; // Tira o padding de pílula
            }

            // Renderiza o Botão (Visual Customizável)
            const btnEl = document.getElementById('btnActivate');
            btnEl.style.backgroundColor = appData.btnBg;
            btnEl.style.color = appData.btnColor;
            btnEl.style.fontWeight = appData.btnBold ? 'bold' : 'normal';
            btnEl.style.fontStyle = appData.btnItalic ? 'italic' : 'normal';

            const couponSection = document.getElementById('coupons-section');
            if (appData.showCoupons === "true") couponSection.style.display = 'flex';
            else couponSection.style.display = 'none';
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? '✅' : (type === 'warning' ? '⚠️' : 'ℹ️');
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function copyToClipboard(target) {
            let textToCopy = (target === 'pingo') ? appData.numPingo : appData.numPoupa;
            let msg = (target === 'pingo') ? "Nº Pingo Doce copiado!" : "Nº Poupa Mais copiado!";
            navigator.clipboard.writeText(textToCopy).then(() => { showAlert(msg, 'success'); })
            .catch(err => { showAlert("Erro ao copiar", 'info'); });
        }

        function activateCoupon() { showAlert("Cupão ativado com sucesso!", 'success'); }

        function closeApp() {
            if (appData.exitLink && appData.exitLink.trim() !== "") window.location.href = appData.exitLink;
            else { try { window.close(); } catch (e) {} window.history.back(); }
        }

        function toggleZoom(show) {
            const modal = document.getElementById('zoomModal');
            show ? modal.classList.add('active') : modal.classList.remove('active');
        }

        function toggleAdmin(show) {
            const panel = document.getElementById('adminPanel');
            if (show) {
                document.getElementById('adminCardImg').value = appData.cardImg;
                document.getElementById('adminNumPingo').value = appData.numPingo;
                document.getElementById('adminNumPoupa').value = appData.numPoupa;
                document.getElementById('adminShowCoupons').value = appData.showCoupons;
                panel.style.display = 'flex';
            } else {
                panel.style.display = 'none';
            }
        }

        function saveUserData() {
            const newUserPrefs = {
                cardImg: document.getElementById('adminCardImg').value,
                numPingo: document.getElementById('adminNumPingo').value,
                numPoupa: document.getElementById('adminNumPoupa').value,
                showCoupons: document.getElementById('adminShowCoupons').value
            };
            localStorage.setItem('myLoyaltyUserPrefs', JSON.stringify(newUserPrefs));
            
            savedUserData = newUserPrefs;
            appData = { ...defaultUserData, ...savedUserData, ...serverData, ...serverStyle };

            renderApp();
            toggleAdmin(false);
            showAlert("Preferências salvas!", 'success');
        }
    </script>
</body>
</html>
